<header class="st2-menu"></header>

<main class="st2-panel">

  <div class="st2-panel__view st2-actions">
    <div class="st2-panel__scroller">

      <div class="st2-panel__toolbar">
        <div class="st2-panel__toolbar-title">
          Actions
        </div>

        <div class="st2-panel__toolbar-search"
            ng-show="groups">
          <form>
            <input type="search"
              class="st2-panel__search-bar"
              placeholder="Filter"
              ng-model="filter">
          </form>
        </div>
      </div>

      <div class="st2-panel__content">

        <div class="st2-flex-table"
            ng-repeat="(name, list) in groups"
            ng-if="groups && !_.isEmpty(groups)">
          <div class="st2-flex-table__caption st2-flex-table__caption--pack"
              ng-click="toggle()">
            <h2 class="st2-flex-table__caption-title">{{ name }}</h2>
          </div>

          <div class="st2-flex-table__header">
            <div class="st2-flex-table__column st2-actions__column-utility">
              <i class="st2-icon__flow-cascade"></i>
            </div>
            <div class="st2-flex-table__column st2-actions__column-name">Name</div>
            <div class="st2-flex-table__column st2-actions__column-type">Runner</div>
            <div class="st2-flex-table__column st2-actions__column-desc">Description</div>
          </div>

          <div class="st2-flex-table__row"
              ng-class-odd="'st2-flex-table__row--odd'"
              ng-class-even="'st2-flex-table__row--even'"
              ng-class="{'st2-flex-table__row--active': action.ref == $parent.action.ref}"
              ng-repeat="action in list"
              ng-click="$root.go({ref: action.ref})">
            <div class="st2-flex-table__column st2-actions__column-utility">
              <i class="st2-icon__flow-cascade"
                ng-if="{'action': action} | isExpandable"></i>
            </div>
            <div class="st2-flex-table__column st2-actions__column-name"
                title="{{ $root.getRef(action) }}">
              {{ action.name }}
            </div>
            <div class="st2-flex-table__column st2-actions__column-type"
                title="{{ action.runner_type }}">
              {{ action.runner_type }}
            </div>
            <div class="st2-flex-table__column st2-actions__column-desc">
              {{ action.description }}
            </div>
          </div>
        </div>

        <div class="st2-panel__content-empty"
            ng-if="groups && _.isEmpty(groups)">
          No results were found for your current filter
        </div>

        <div class="st2-panel__content-error"
            ng-if="error && _.isEmpty(groups)">
          Request failed: {{ error }}
        </div>
      </div>
    </div>

    <div class="st2-loader"></div>
  </div>

  <div class="st2-panel__details st2-details"
      ng-show="action">
    <div class="st2-details__tabs">
      <div class="st2-details__tab-label"
          ng-class="{'st2-details__tab-label--active': $root.isState(['^.general', '^.list'])}"
          ng-click="$root.state.go('^.general', {ref: action.ref})">
        <i class="st2-icon__cogs"></i>
        General
      </div>

      <div class="st2-details__tab-body"
          ng-class="{'st2-details__tab-body--active': $root.isState(['^.general', '^.list'])}">
        <div class="st2-panel__scroller">

          <div class="st2-details__panel">

            <div class="st2-details__panel-body">
              <div class="st2-details__panel-body-line">
                <div class="st2-details__panel-body-label">Name</div>
                <div class="st2-details__panel-body-value">{{ $root.getRef(action) }}</div>
              </div>

              <div class="st2-details__panel-body-line">
                <div class="st2-details__panel-body-label">Description</div>
                <div class="st2-details__panel-body-value">{{ action.description }}</div>
              </div>

              <div class="st2-details__panel-body-line">
                <div class="st2-details__panel-body-label"
                    ng-if="!_.isEmpty(executions)">
                  Latest Execution Status
                </div>
                <div class="st2-details__panel-body-value"
                    ng-if="!_.isEmpty(executions)">
                  <span class="st2-label"
                    status="_.last(executions).status">
                  </span>
                </div>
              </div>
            </div>

          </div>

          <div class="st2-details__panel">
            <div class="st2-details__panel-heading">
              <h2 class="st2-details__panel-title">Parameters</h2>
            </div>
            <div class="st2-details__panel-body">
              <form role="form" class="st2-details__form"
                  ng-submit="runAction(action, payload)">
                <div class="st2-details__panel-empty"
                    ng-if="_.isEmpty(action.parameters) || _.every(action.parameters, 'immutable')">
                  Action has no mutable parameters
                </div>
                <div class="st2-auto-form"
                  spec="action.parameters"
                  result="payload">
                </div>
                <button type="submit" class="st2-forms__button">Run</button>
              </form>
            </div>
          </div>

          <div class="st2-details__panel">
            <div class="st2-details__panel-heading">
              <h2 class="st2-details__panel-title">
                Executions
              </h2>
            </div>
            <div class="st2-details__panel-body">

              <div class="st2-flex-table" ng-if="!_.isEmpty(history)">
                <div class="st2-flex-table__header">
                  <div class="st2-flex-table__column st2-actions__details-column-utility"></div>
                  <div class="st2-flex-table__column st2-actions__details-column-meta"></div>
                  <div class="st2-flex-table__column st2-actions__details-column-time">Time</div>
                </div>

                <div class="st2-flex-table__row"
                    ng-class-odd="'st2-flex-table__row--odd'"
                    ng-class-even="'st2-flex-table__row--even'"
                    ng-repeat-start="record in history | orderBy:'execution.start_timestamp':true | limitTo:5"
                    ng-click="expand(record, $event)">

                  <div class="st2-flex-table__column st2-actions__details-column-utility">
                    <i ng-class="'st2-icon__' + (record._expanded && 'down-open' || 'right-open')">
                    </i>
                  </div>

                  <div class="st2-flex-table__column st2-actions__details-column-meta">
                    <div class="st2-actions__details-column-meta-status">
                      <span class="st2-label st2-label--short"
                        status="record.execution.status"></span>
                      <i class="st2-icon__flow-cascade"
                        ng-if="(record | isExpandable)"></i>
                    </div>
                    <!-- <div class="st2-actions__details-column-meta-time">
                      {{ record.execution.start_timestamp | date:'mediumTime' }}
                    </div> -->
                  </div>

                  <!-- <div class="st2-flex-table__column st2-actions__details-column-status">
                    <div class="st2-label" status="record.execution.status"></div>
                  </div> -->
                  <div class="st2-flex-table__column st2-actions__details-column-time">
                    {{ record.execution.start_timestamp | date:'medium' }}
                  </div>

                  <div class="st2-flex-table__column st2-actions__details-column-history"
                      ng-click="$root.state.go('history.general', {action: $root.getRef(action), id: record.id}); $event.stopPropagation()">
                    <i class="st2-icon__history"></i>
                </div>

                </div>
                <div class="st2-flex-table__insert"
                    ng-show="!(record | isExpandable) && record._expanded">

                  <div class="st2-details__panel-body">
                    <div class="st2-action-reporter"
                      runner="record.runner.name"
                      execution="record.execution"></div>
                  </div>
                </div>
                <div class="st2-history-child"
                  workflow="record"
                  view="workflowView"
                  ng-if="(record | isExpandable) && record._expanded"
                  ng-repeat-end>
                </div>
              </div>

              <div class="st2-details__panel-empty" ng-if="_.isEmpty(history)">
                No history records for this action
              </div>

              <a class="st2-forms__button"
                  ui-sref="history.list({action: $root.getRef(action)})">
                <i class="st2-icon__eye"></i>
                See full action history
              </a>
            </div>
          </div>

        </div>

      </div>

      <div class="st2-details__tab-label"
          ng-class="{'st2-details__tab-label--active': $root.isState('^.code')}"
          ng-click="$root.state.go('^.code', {ref: action.ref})"
          ng-if="actionHasFile(action)">
        <i class="st2-icon__code"></i>
        Code
      </div>

      <div class="st2-details__tab-body"
          ng-class="{'st2-details__tab-body--active': $root.isState('^.code')}"
          ng-if="actionHasFile(action)">
        <div class="st2-panel__scroller">

          <div class="st2-details__panel">
            <div class="st2-details__panel-heading">
              <h2 class="st2-details__panel-title">File</h2>
            </div>
            <div class="st2-details__panel-body">
              <div class="st2-highlight" code="file" full="true"></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

</main>
