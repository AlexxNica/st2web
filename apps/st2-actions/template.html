<header class="st2-menu"></header>

<main class="st2-panel">

  <div class="st2-panel__view st2-actions">
    <div class="st2-panel__scroller">

      <div class="st2-panel__toolbar">
        <div class="st2-panel__toolbar-title">
          Actions
        </div>

        <div class="st2-panel__toolbar-search">
          <form>
            <input type="search"
              class="st2-panel__search-bar"
              placeholder="Filter"
              ng-model="filter">
          </form>
        </div>
      </div>

      <div class="st2-panel__content">

        <div class="st2-flex-table"
            ng-repeat="(name, list) in groups"
            ng-if="groups && !_.isEmpty(groups)">
          <div class="st2-flex-table__caption st2-flex-table__caption--pack"
              ng-click="toggle()">
            <h2 class="st2-flex-table__caption-title">{{ name }}</h2>
          </div>

          <div class="st2-flex-table__header">
            <div class="st2-flex-table__column st2-actions__column-utility">
              <i class="st2-icon__flow-cascade"></i>
            </div>
            <div class="st2-flex-table__column st2-actions__column-name">Name</div>
            <div class="st2-flex-table__column st2-actions__column-type">Runner</div>
            <div class="st2-flex-table__column st2-actions__column-desc">Description</div>
          </div>

          <div class="st2-flex-table__row"
              ng-class-odd="'st2-flex-table__row--odd'"
              ng-class-even="'st2-flex-table__row--even'"
              ng-class="{'st2-flex-table__row--active': action.id == $parent.action.id}"
              ng-repeat="action in list"
              ng-click="$root.go({id: action.id, page: $root.page})">
            <div class="st2-flex-table__column st2-actions__column-utility">
              <i class="st2-icon__flow-cascade"
                ng-if="isWorkflow(action)"></i>
            </div>
            <div class="st2-flex-table__column st2-actions__column-name">
              {{ $root.getRef(action) }}
            </div>
            <div class="st2-flex-table__column st2-actions__column-type">
              {{ action.runner_type }}
            </div>
            <div class="st2-flex-table__column st2-actions__column-desc">
              {{ action.description }}
            </div>
          </div>
        </div>

        <div class="st2-panel__content-empty"
            ng-if="groups && _.isEmpty(groups)">
          No results were found for your current filter
        </div>

      </div>
    </div>

    <div class="st2-loader"></div>
  </div>

  <div class="st2-panel__details st2-details">
    <div class="st2-details__tabs">
      <div class="st2-details__tab-label"
          ng-class="{'st2-details__tab-label--active': $root.isState(['^.general', '^.list'])}"
          ng-click="$root.state.go('^.general', {id: action.id})">
        <i class="st2-icon__cogs"></i>
        General
      </div>

      <div class="st2-details__tab-body"
          ng-class="{'st2-details__tab-body--active': $root.isState(['^.general', '^.list'])}">
        <div class="st2-panel__scroller">

          <div class="st2-details__panel">

            <div class="st2-details__panel-body">
              <div class="st2-details__panel-body-line">
                <div class="st2-details__panel-body-label">Name</div>
                <div class="st2-details__panel-body-value">{{ $root.getRef(action) }}</div>
              </div>

              <div class="st2-details__panel-body-line">
                <div class="st2-details__panel-body-label">Description</div>
                <div class="st2-details__panel-body-value">{{ action.description }}</div>
              </div>

              <div class="st2-details__panel-body-line">
                <div class="st2-details__panel-body-label"
                    ng-if="!_.isEmpty(executions)">
                  Latest Execution Status
                </div>
                <div class="st2-details__panel-body-value"
                    ng-if="!_.isEmpty(executions)">
                  <span class="st2-label"
                    status="_.last(executions).status">
                  </span>
                </div>
              </div>
            </div>

          </div>

          <div class="st2-details__panel">
            <div class="st2-details__panel-heading">
              <h2 class="st2-details__panel-title">Parameters</h2>
            </div>
            <div class="st2-details__panel-body">
              <form role="form" class="st2-details__form"
                  ng-submit="runAction(action, payload)">
                <div class="st2-details__panel-empty"
                    ng-if="_.isEmpty(action.parameters) || _.every(action.parameters, 'immutable')">
                  Action has no mutable parameters
                </div>
                <div class="st2-auto-form"
                  spec="action.parameters"
                  result="payload">
                </div>
                <button type="submit" class="st2-forms__button">Run</button>
              </form>
            </div>
          </div>

          <div class="st2-details__panel">
            <div class="st2-details__panel-heading">
              <h2 class="st2-details__panel-title">
                Executions
                <i class="st2-details__reload-button"
                  ng-class="{'st2-details__reload-button--in-progress': inProgress}"
                  ng-click="inProgress || reloadExecutions(action)"></i>
              </h2>
            </div>
            <div class="st2-details__panel-body">

              <div class="st2-flex-table" ng-if="!_.isEmpty(history)">
                <div class="st2-flex-table__header">
                  <div class="st2-flex-table__column st2-actions__details-column-time">Time</div>
                  <div class="st2-flex-table__column st2-actions__details-column-status">Status</div>
                </div>

                <div class="st2-flex-table__row"
                    ng-class-odd="'st2-flex-table__row--odd'"
                    ng-class-even="'st2-flex-table__row--even'"
                    ng-repeat="record in history | orderBy:'execution.start_timestamp':true | limitTo:5"
                    ui-sref="history.general({action: $root.getRef(action), id: record.id})">
                  <div class="st2-flex-table__column st2-actions__details-column-time">
                    {{ record.execution.start_timestamp | date:'medium' }}
                  </div>
                  <div class="st2-flex-table__column st2-actions__details-column-status">
                    <div class="st2-label" status="record.execution.status"></div>
                  </div>
                </div>
              </div>

              <div class="st2-details__panel-empty" ng-if="_.isEmpty(history)">
                No history records for this action
              </div>

              <a class="st2-forms__button"
                  ui-sref="history.list({action: $root.getRef(action)})">
                <i class="st2-icon__eye"></i>
                See full action history
              </a>
            </div>
          </div>

        </div>

      </div>

      <div class="st2-details__tab-label"
          ng-class="{'st2-details__tab-label--active': $root.isState('^.code')}"
          ng-click="$root.state.go('^.code', {id: action.id})"
          ng-if="actionHasFile(action)">
        <i class="st2-icon__code"></i>
        Code
      </div>

      <div class="st2-details__tab-body"
          ng-class="{'st2-details__tab-body--active': $root.isState('^.code')}"
          ng-if="actionHasFile(action)">
        <div class="st2-panel__scroller">

          <div class="st2-details__panel">
            <div class="st2-details__panel-heading">
              <h2 class="st2-details__panel-title">File</h2>
            </div>
            <div class="st2-details__panel-body">
              <div class="st2-details__well" hljs source="file"></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

</main>
