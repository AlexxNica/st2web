<header class="st2-menu"></header>

<main class="st2-panel">

  <div class="st2-panel__view st2-history">

    <div class="st2-panel__scroller">

      <div class="st2-panel__toolbar">
        <div class="st2-panel__toolbar-title">
          History
        </div>

        <div class="st2-panel__toolbar-filters">
          <div class="st2-filter" filters="filters" type="action"></div>
          <div class="st2-filter" filters="filters" type="trigger_type" label="Trigger Type"></div>
          <div class="st2-filter" filters="filters" type="rule"></div>
        </div>

        <div class="st2-panel__toolbar-search">
          <form>
            <input type="search"
              class="st2-panel__search-bar"
              placeholder="Search">
          </form>
        </div>
      </div>

      <div class="st2-panel__content">
        <div class="st2-flex-table"
            ng-repeat="group in groups = (history | orderBy:'period':true)"
            ng-if="history && !_.isEmpty(groups)">

          <div class="st2-flex-table__caption st2-flex-table__caption--date"
              ng-click="toggle()">
            <h2 class="st2-flex-table__caption-title">{{ group.period | date:'fullDate'}}</h2>
          </div>

          <div class="st2-flex-table__header">
            <div class="st2-flex-table__column st2-history__column-utility"></div>
            <div class="st2-flex-table__column st2-history__column-time">Started At</div>
            <div class="st2-flex-table__column st2-history__column-action">Action Name</div>
            <div class="st2-flex-table__column st2-history__column-triggered">Triggered By</div>
            <div class="st2-flex-table__column st2-history__column-status">Status</div>
          </div>

          <div class="st2-flex-table__row"
              ng-class-odd="'st2-flex-table__row--odd'"
              ng-class-even="'st2-flex-table__row--even'"
              ng-class="{'st2-flex-table__row--active': record.id == $parent.record.id}"
              ng-repeat-start="record in group.records"
              ng-click="$root.go(_.defaults({id: record.id}, $root.state.params))">
            <div class="st2-flex-table__column st2-history__column-utility"
                ng-click="isExpandable(record) && expand(record, $event)">
              <i ng-class="record._expanded && 'st2-icon__down-open' || 'st2-icon__right-open'"
                  ng-if="isExpandable(record)">
              </i>
            </div>
            <div class="st2-flex-table__column st2-history__column-time">
              {{ record.execution.start_timestamp | date:'mediumTime' }}
            </div>
            <div class="st2-flex-table__column st2-history__column-action">
              {{ $root.getRef(record.action) }}
            </div>
            <div class="st2-flex-table__column st2-history__column-triggered"
                ng-switch="record.rule && record.trigger && true">
              <span ng-switch-when="true">{{ record.rule.name }} ({{ record.trigger.type }})</span>
              <span ng-switch-default>Manual</span>
            </div>
            <div class="st2-flex-table__column st2-history__column-status">
              <span class="st2-label" status="record.execution.status"></span>
            </div>
          </div>
          <div class="st2-history-child"
              children="record._children"
              ng-if="isExpandable(record) && record._expanded">
          </div>
          <div ng-repeat-end
              class="st2-flex-table__header"
              ng-if="isExpandable(record) && record._expanded && !$last">
            <div class="st2-flex-table__column st2-history__column-utility"></div>
            <div class="st2-flex-table__column st2-history__column-time">Started At</div>
            <div class="st2-flex-table__column st2-history__column-action">Action Name</div>
            <div class="st2-flex-table__column st2-history__column-triggered">Triggered By</div>
            <div class="st2-flex-table__column st2-history__column-status">Status</div>
          </div>

        </div>

        <div class="st2-panel__content-empty"
            ng-if="history && _.isEmpty(groups)">
          No results were found for your current filter
        </div>
      </div>

      <button class="st2-panel__prev-button st2-forms__button-left"
          ng-click="prevPage()"
          ng-if="$root.page > 1">
        Previous page
      </button>
      <button class="st2-panel__next-button st2-forms__button-right"
          ng-click="nextPage()"
          ng-if="($root.page || 1) < $root.maxPage">
        Next page
      </button>

    </div>

    <div class="st2-loader"></div>
  </div>

  <div class="st2-panel__details st2-details">
    <div class="st2-panel__scroller">

      <div class="st2-details__panel">
        <div class="st2-details__panel-heading">
          <h2 class="st2-details__panel-title">History Record Details</h2>
        </div>
        <div class="st2-details__panel-body">
          <dl class="st2-details__panel-body-line">
            <dt class="st2-details__panel-body-label"
                ng-if="record.rule.name">
              Rule Name
            </dt>
            <dd class="st2-details__panel-body-value"
                ng-if="record.rule.name">
              {{ record.rule.name }}
            </dd>
          </dl>
          <dl class="st2-details__panel-body-line">
            <dt class="st2-details__panel-body-label"
                ng-if="record.rule.description">
              Rule Description
            </dt>
            <dd class="st2-details__panel-body-value"
                ng-if="record.rule.description">
              {{ record.rule.description }}
            </dd>
          </dl>
          <dl class="st2-details__panel-body-line">
            <dt class="st2-details__panel-body-label"
                ng-if="record.trigger.name">
              Trigger Name
            </dt>
            <dd class="st2-details__panel-body-value"
                ng-if="record.trigger.name">
              {{ record.trigger.name }}
            </dd>
          </dl>
          <dl class="st2-details__panel-body-line">
            <dt class="st2-details__panel-body-label"
                ng-if="record.trigger_instance.occurrence_time">
              Occurrence time
            </dt>
            <dd class="st2-details__panel-body-value"
                ng-if="record.trigger_instance.occurrence_time">
              {{ record.trigger_instance.occurrence_time | date:'medium' }}
            </dd>
          </dl>
          <dl class="st2-details__panel-body-line">
            <dt class="st2-details__panel-body-label"
                ng-if="record.trigger_instance.payload">
              Trigger payload
            </dt>
            <dd class="st2-details__panel-body-value"
                ng-if="record.trigger_instance.payload">
              <div class="st2-details__well"
                hljs source="record.trigger_instance.payload | json"></div>
            </dd>
          </dl>
          <dl class="st2-details__panel-body-line">
            <dt class="st2-details__panel-body-label">Action</dt>
            <dd class="st2-details__panel-body-value">{{ $root.getRef(record.action) }}</dd>
          </dl>
          <dl class="st2-details__panel-body-line">
            <dt class="st2-details__panel-body-label">Runner</dt>
            <dd class="st2-details__panel-body-value">{{ record.action.runner_type }}</dd>
          </dl>
        </div>
      </div>

      <div class="st2-details__panel">
        <div class="st2-details__panel-heading">
          <h2 class="st2-details__panel-title">Action Input</h2>
        </div>
        <div class="st2-details__panel-body">
          <form role="form" class="st2-details__form">
            <div class="st2-auto-form"
              spec="spec"
              result="payload">
            </div>
          </form>
        </div>
      </div>

      <div class="st2-details__panel">
        <div class="st2-details__panel-heading">
          <h2 class="st2-details__panel-title">Action Output</h2>
        </div>
        <div class="st2-details__panel-body">
          <div class="st2-action-reporter"
            runner="record.runner.name"
            execution="record.execution"></div>
        </div>
      </div>

    </div>
  </div>

</main>
